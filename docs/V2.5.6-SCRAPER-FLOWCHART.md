# V2.5.6 Spirits Scraper System Flowchart

## Overview
This document provides a visual representation of how the V2.5.6 intelligent distillery scraper works, from command execution to data storage.

## Main Scraper Flow

```mermaid
flowchart TD
    Start([User runs: npm run scrape-catalogs]) --> ParseOptions{Parse Command Options}
    
    ParseOptions --> ClearTracking{Clear Tracking?}
    ClearTracking -->|Yes| ClearData[Clear All Tracking Data]
    ClearData --> End1([End])
    
    ClearTracking -->|No| InitTracker[Initialize Distillery Tracker]
    InitTracker --> StartSession[Start New Scraping Session]
    StartSession --> ShowStats[Display Previous Scraping Stats]
    
    ShowStats --> SelectMode{Specific Distilleries?}
    
    SelectMode -->|Yes| FindSpecific[Find Specified Distilleries]
    SelectMode -->|No| IntelligentSelect[Intelligent Selection Algorithm]
    
    IntelligentSelect --> GetUnscraped[Get Unscraped Distilleries]
    GetUnscraped --> FilterByAge[Filter by Days Since Last Scrape]
    FilterByAge --> GroupByType[Group by Spirit Type]
    GroupByType --> PrioritySort[Sort by Priority & Product Lines]
    PrioritySort --> SelectDistilleries[Select Optimal Distilleries]
    
    FindSpecific --> ValidateDistilleries{Valid Distilleries?}
    ValidateDistilleries -->|No| Error1[Show Error]
    Error1 --> End2([End])
    ValidateDistilleries -->|Yes| SelectDistilleries
    
    SelectDistilleries --> ShowSelected[Display Selected Distilleries & Type Coverage]
    ShowSelected --> ProcessLoop{More Distilleries & API Calls?}
    
    ProcessLoop -->|No| ShowSummary[Display Final Summary]
    ProcessLoop -->|Yes| CheckRecord[Check Distillery Record]
    
    CheckRecord --> RecentlyCached{Scraped < 3 days ago?}
    RecentlyCached -->|Yes| ShowCacheNotice[Show Cache Notice]
    RecentlyCached -->|No| GenerateQueries[Generate Smart Queries]
    ShowCacheNotice --> GenerateQueries
    
    GenerateQueries --> ProcessQueries{Process Each Query}
    ProcessQueries --> CheckCache{Query Cached?}
    
    CheckCache -->|Yes| UseCached[Use Cached Results]
    CheckCache -->|No| CallAPI[Call Google Search API]
    
    CallAPI --> ProcessResults[Process Search Results]
    UseCached --> ProcessResults
    
    ProcessResults --> ExtractSpirits[Extract Spirits from Results]
    ExtractSpirits --> ValidateSpirit{Valid Product?}
    
    ValidateSpirit -->|No| SkipSpirit[Skip Non-Product]
    ValidateSpirit -->|Yes| ApplyFixes[Apply V2.5.6 Fixes]
    
    SkipSpirit --> NextSpirit{More Spirits?}
    ApplyFixes --> StoreSpirit[Store in Database]
    
    StoreSpirit --> TrackType[Track Spirit Type]
    TrackType --> UpdateMetrics[Update Metrics]
    UpdateMetrics --> NextSpirit
    
    NextSpirit -->|Yes| ValidateSpirit
    NextSpirit -->|No| RecordScrape[Record Distillery Scrape]
    
    RecordScrape --> UpdateSession[Update Session Progress]
    UpdateSession --> ProcessLoop
    
    ShowSummary --> CheckDedup{Stored >= 50 Spirits?}
    CheckDedup -->|Yes| RunDedup[Run Auto-Deduplication]
    CheckDedup -->|No| ShowRecommend[Show Next Run Recommendations]
    RunDedup --> ShowRecommend
    ShowRecommend --> End3([End])
```

## V2.5.6 Fixes Application Flow

```mermaid
flowchart LR
    Spirit[Raw Spirit Data] --> Fix1[Fix Empty Parentheses]
    Fix1 --> Fix2[Extract Brand Name]
    Fix2 --> Fix3[Validate Product Name]
    Fix3 --> Fix4[Fix Year Prefix]
    Fix4 --> Fix5[Normalize Text]
    Fix5 --> Fix6[Extract Metadata]
    Fix6 --> Fixed[Fixed Spirit Data]
    
    Fix2 --> BrandCheck{Known Brand?}
    BrandCheck -->|No| CheckMulti{Multi-word Exception?}
    CheckMulti -->|No| Unknown[Set Brand: Unknown]
    CheckMulti -->|Yes| UseBrand[Use Original Brand]
    BrandCheck -->|Yes| UseBrand
    
    Fix3 --> NameCheck{Valid Product?}
    NameCheck -->|No| Reject[Reject Spirit]
    NameCheck -->|Yes| Continue[Continue Processing]
```

## Intelligent Selection Algorithm

```mermaid
flowchart TD
    AllDist[All 908 Distilleries] --> Filter1{Never Scraped?}
    Filter1 -->|Priority 1| NeverScraped[Never Scraped List]
    Filter1 -->|Check Age| Filter2{> 7 Days Old?}
    Filter2 -->|Priority 2| OldScrapes[Old Scrapes List]
    Filter2 -->|Recent| Filter3{> 3 Days Old?}
    Filter3 -->|Priority 3| RecentScrapes[Semi-Recent List]
    Filter3 -->|Too Recent| Skip[Skip Distillery]
    
    NeverScraped --> TypeDist[Distribute by Spirit Type]
    OldScrapes --> TypeDist
    RecentScrapes --> TypeDist
    
    TypeDist --> CalcSlots[Calculate Slots per Type]
    CalcSlots --> PriorityScore[Calculate Priority Score]
    
    PriorityScore --> Score1[Base Priority: 1-10]
    Score1 --> Score2[+ Type Count * 2]
    Score2 --> Score3[+ Product Lines Count]
    Score3 --> FinalScore[Final Priority Score]
    
    FinalScore --> SortSelect[Sort & Select Top N]
    SortSelect --> Shuffle[Slight Shuffle for Variety]
    Shuffle --> Selected[Final Selection]
```

## Data Extraction Pipeline

```mermaid
flowchart TD
    SearchResult[Google Search Result] --> Extract1{Has Structured Data?}
    Extract1 -->|Yes| ParseProduct[Parse Product Schema]
    Extract1 -->|No| Extract2{Has Metatags?}
    
    ParseProduct --> ExtractName[Extract Name]
    Extract2 -->|Yes| ParseMeta[Parse OG/Twitter Tags]
    Extract2 -->|No| ParseSnippet[Parse Snippet Text]
    
    ParseMeta --> ExtractName
    ParseSnippet --> ExtractName
    
    ExtractName --> ExtractPrice[Extract Price]
    ExtractPrice --> ExtractABV[Extract ABV/Proof]
    ExtractABV --> ExtractDesc[Extract Description]
    ExtractDesc --> ExtractImage[Extract Image URL]
    ExtractImage --> ExtractMeta[Extract Advanced Metadata]
    
    ExtractMeta --> DetectType[Detect Spirit Type]
    DetectType --> CalcQuality[Calculate Quality Score]
    CalcQuality --> FinalSpirit[Complete Spirit Object]
```

## Cache & Deduplication Flow

```mermaid
flowchart LR
    Query[Search Query] --> CacheCheck{In Cache?}
    CacheCheck -->|Hit| GetCache[Get Cached Results]
    CacheCheck -->|Miss| APICall[Google API Call]
    APICall --> StoreCache[Store in Cache]
    StoreCache --> ProcessCache[Process Results]
    GetCache --> ProcessCache
    
    ProcessCache --> ForEach[For Each Spirit]
    ForEach --> Dedup{Duplicate Check}
    Dedup -->|Similar Name| CompareYear{Different Year?}
    CompareYear -->|Yes| NotDupe[Not Duplicate]
    CompareYear -->|No| CompareBatch{Different Batch?}
    CompareBatch -->|Yes| NotDupe
    CompareBatch -->|No| IsDupe[Is Duplicate]
    Dedup -->|Different| NotDupe
    
    NotDupe --> Store[Store Spirit]
    IsDupe --> Skip[Skip Spirit]
```

## Session Tracking Structure

```mermaid
flowchart TD
    Session[Scraping Session] --> Tracker[Distillery Tracker]
    Tracker --> Redis[(Redis/Upstash)]
    
    Redis --> Records[Distillery Records]
    Redis --> Sessions[Session History]
    Redis --> Stats[Global Statistics]
    
    Records --> Record1[Distillery Name]
    Record1 --> Record2[Last Scraped Date]
    Record2 --> Record3[Spirits Found/Stored]
    Record3 --> Record4[API Calls Used]
    Record4 --> Record5[Efficiency Score]
    Record5 --> Record6[Spirit Types Found]
    
    Sessions --> Session1[Session ID]
    Session1 --> Session2[Start Time]
    Session2 --> Session3[Distilleries Scraped]
    Session3 --> Session4[Total API Calls]
    Session4 --> Session5[Total Spirits]
```

## Key Features Highlighted

1. **Intelligent Selection**: Prioritizes unscraped distilleries and ensures coverage across all spirit types
2. **Cache Awareness**: Checks cache before making API calls, saving time and money
3. **V2.5.6 Fixes**: Applies comprehensive fixes to ensure data quality
4. **Deduplication**: Smart duplicate detection that preserves variations (different years, batches)
5. **Session Tracking**: Remembers what was scraped to avoid redundant work
6. **Multi-Spirit Support**: Works with bourbon, scotch, vodka, gin, rum, tequila, and more

## Usage Examples

```bash
# Default intelligent scraping (100 API calls)
npm run scrape-catalogs

# Custom API calls
npm run scrape-catalogs -- -a 200

# Specific distilleries
npm run scrape-catalogs -- -d "Buffalo Trace,Glenfiddich,Grey Goose"

# Clear tracking and start fresh
npm run scrape-catalogs -- --clear-tracking
```

## Performance Metrics

- **Efficiency Target**: 5-10 spirits per API call
- **Cache Hit Rate**: Typically 20-40% after initial runs
- **Coverage**: All major spirit categories
- **Deduplication**: ~95% accuracy with year/batch awareness
- **Storage Rate**: 50-80% of found spirits (after deduplication)